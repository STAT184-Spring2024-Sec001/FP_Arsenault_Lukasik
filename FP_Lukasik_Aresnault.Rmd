---
title: "Final Project"
author: "Jacob Lukasik and Will Arsenault"
date: "2024-04-12"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```

## STAT184 Final Project: Analyzing Data From the FIA Formula 1 World Championship

For this project, we have found a very vast dataset regarding the FIA Formula 1 World Championship which contains Driver and Constructor information as well as, lap times, race results, and pit stop data from the inaugural season of the FIA Formula 1 World Championship, 1950, all the way up to the end of the 2023 season. With this dataset, we are striving to find and assess any connections that may be found that can show the relationships lap times and race success, along with qualifying performance and how well qualifying sets the driver up for success in the race. Lastly, we hope to look for any trends over the history of F1 that effect on track performance.

Link to the dataset:

<https://www.kaggle.com/datasets/rohanrao/formula-1-world-championship-1950-2020?select=results.csv>

## Step 1: Loading Data and Necessary Libraries

```{r message=FALSE}
library(ggplot2)
library(dplyr)
library(janitor)
library(kableExtra)
library(knitr)
```

```{r}
circuits <- read.csv('circuits.csv', header = TRUE)
const_results <- read.csv('constructor_results.csv', header = TRUE)
const_standings <- read.csv('constructor_standings.csv', header = TRUE)
constructors <- read.csv('constructors.csv', header = TRUE)
driver_standings <- read.csv('driver_standings.csv', header = TRUE)
drivers <- read.csv('drivers.csv', header = TRUE)
lap_times <- read.csv('lap_times.csv', header = TRUE)
pit_stops <- read.csv('pit_stops.csv', header = TRUE)
qualifying <- read.csv('qualifying.csv', header = TRUE)
races <- read.csv('races.csv', header = TRUE)
results <- read.csv('results.csv', header = TRUE)
seasons <- read.csv('seasons.csv', header = TRUE)
status <- read.csv('status.csv', header = TRUE)
```

The first insight into lap times we planned on finding was how lap times have gotten faster over the long history of Formula 1. To investigate this, we will first filter our data so that we have the fastest lap time from every season of F1 at Monza. We have keened in on this circuit in particular because it has been a mainstay in nearly every Formula 1 season, only not having a race held there in the 1980 season. Once we have a data frame containing just information regarding the fastest lap time at Monza every season, we can make a line graph and look for trends.

```{r}
simplified_races <- races %>% # simplifying the 'races' table for use later on
  select(raceId, year, circuitId, name)
only_monza <- races %>% # first we will only find races at monza from the 'races' data frame, then we will use those races to find the fastest lap times in 'results'
  filter(circuitId == 14) # inspecting the 'circuits' data frame tells us that Monza's circuitId is 14
monza_fastest_laps <- results %>% # now we will make a table with just the fastest lap time from every year
  filter(raceId %in% only_monza$raceId) %>% # making sure we only look at races at Monza
  filter(!is.na(fastestLapTime) & fastestLapTime != '\\N') %>% # make sure no N/A values are present
  group_by(raceId) %>% 
  summarize(fastestLapTime = min(fastestLapTime, na.rm = TRUE)) %>% # only contain the fastest lap time from each race
  left_join(simplified_races, by = "raceId") # join with the 'simplified_races' table to see what year the race was

ggplot(monza_fastest_laps, aes(x = year, y = fastestLapTime)) +
  geom_point(color = "blue", size = 3) +  # scatter plot with blue points
  labs(x = "Year", y = "Fastest Lap Time") + # labels for axes
  ggtitle("Fastest Lap Time by Year") + # main title
  theme_minimal() +  # minimalist theme
  theme(axis.text = element_text(size = 16), # axis text size
        axis.title = element_text(size = 16), # axis title size
        plot.title = element_text(size = 20, face = "bold")) # plot title size and style
```

Above, we can see that, since the year 2004 when the FIA started consistently keeping track of lap times, the cars have gotten overall slower than they were in the early 2000s. Now that we generally know the trend of lap times over the years, we can look more in depth at different statistics.

Now, we will see how often the driver who holds the title for the fastest lap time in a race, wins that race, along with how many times that driver has pulled off that feat.

Furthermore, we can also count the number of races since 2004 and then keep track of the percentage of times the fastest lap has converted into a race win.

```{r}
fastest_lap_wins <- results %>% # create a new data frame with just drivers who have won with the fastest lap
  filter(rank == 1) %>% # filter it so only fastest lap rows appear
  filter(positionOrder == 1) %>% # filter it so only winning drivers rows appear
  left_join(drivers, by = 'driverId') %>% # merge so that we can get the drivers name as well
  distinct(raceId, forename, surname, fastestLapTime) # pick out the information we need 

races_since_2004 <- races %>% # use this to calculate percentage later
  filter(year >= 2004)

summary_table <- fastest_lap_wins %>% # create a summary table
  tabyl(surname) %>% # group by surname
  adorn_totals() %>% # get the totals 
  arrange(desc(n)) %>% # sort from most to least
  rename("Surname" = surname, "Count" = n) %>% # rename columns for viewer
  select(Surname, Count) %>% # drop the percentage
  mutate("Percentage of All Races Since '04" = round(Count / nrow(races_since_2004), 3)) # create the new appropriate percentage 
  
# rendering the summary table using knitr
kable(summary_table) %>%
  kable_styling(font_size = 18, full_width = TRUE) %>%
  add_header_above(c("Most Wins While Simultaneously Winning Fastest Lap" = 3))
```

From this table, we can see that the driver with the fastest lap has won the same grand prix in around 31% of races since the year 2004. Along with that, we can see the different drivers who have done it the most time. From this, we learn the importance of recording fast lap times as, like said earlier, the driver with the highest chance of winning most of the time holds the title of the fastest lap.

From here, we can continue to look at other statistics and how they effect the outcome in the race. The next visualization will look at qualifying time and how often qualifying each first, second, third, fourth, and fifth generates a race win.

# Examining Qualifying Position

## Qualifying Positions Impact on Race Wins

From here, we can continue to look at other statistics and how they affect the outcome in the race. The next visualization will look at qualifying time and how often qualifying each first, second, third, fourth, and fifth generates a race win. We will make a bar graph to display the amount of times the qualifying positions of 1st - 5th actually won the race. We also can filter the drivers in qualifying positions 6-28 and add there wins to see how there total count if wins compares to the drivers in the qualifying positions 1st-5th.

```{r}
# Filter qualifying positions 1st to 5th
qualifying_positions <- qualifying %>%
  filter(position <= 5) # Filter the qualifying positions 1st-5th

# Join with results on raceId and driverId
qualifying_results <- qualifying_positions %>%
  inner_join(results, by = c("raceId", "driverId"))

# Filter where positionOrder is 1 (indicating the driver won the race)
qualifying_winners <- qualifying_results %>%
  filter(positionOrder == 1)

# Calculate the number of race wins for each qualifying position
win_counts <- qualifying_winners %>%
  group_by(position.x) %>%
  summarize(race_wins = n())

# Create a new category for all other qualifying positions
other_positions <- qualifying %>%
  filter(!(position %in% 1:5)) %>%
  mutate(position.x = "Other (6-28)")

# Join with results on raceId and driverId
other_results <- other_positions %>%
  inner_join(results, by = c("raceId", "driverId"))

# Filter where positionOrder is 1 (indicating the driver won the race)
other_winners <- other_results %>%
  filter(positionOrder == 1)

# Calculate the number of race wins for "Other" qualifying positions
other_win_counts <- other_winners %>%
  group_by(position.x.x) %>%
  summarize(race_wins = n()) %>%
  rename("position.x" = position.x.x)

# Combine win_counts and other_win_counts
win_counts$position.x <- as.character(win_counts$position.x)
combined_win_counts <- bind_rows(win_counts, other_win_counts)

# Create a vector of colors
bar_colors <- c("skyblue", "lightgreen", "orange", "pink", "purple", "gray")  # Add a color for "Other"

# Make the bar graph with ggplot2
ggplot(combined_win_counts, aes(x = factor(position.x), y = race_wins, fill = factor(position.x))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = bar_colors) +  # Apply custom colors
  labs(x = "Qualifying Position", y = "Number of Race Wins", 
       title = "Race Wins by Qualifying Position") +
  theme_minimal() +
  theme(axis.text = element_text(size = 14), # Change font sizes
        axis.title = element_text(size = 18), 
        plot.title = element_text(size = 20, face = "bold"),
        legend.position = "none") +  # Remove legend
  guides(fill = 'none')  # Remove fill guide
```

As we can see from the above bar graph, a majority of the time the racer who is in the 1st qualifying position will actually win the race. The number of wins rapidly decreases as each qualifying postion increases. There could be a variety of factors that contributed to the 1st qualifying positon winning the most races. The main factor definitely would be the driver skill because the driver had to do something in order to get that high of a qualifying position for that specific race. If you did not know the qualifying position is similar to a ranking system in sports. The highest ranked driver for that specific race will get the highest qualifying position. This allows that driver to get a bit of a head start on top of all the other drivers that are participating in that race.

We also did calculations for all other drivers in the race (qualifying places 6-28). As you can see in the above graph the category of 6-28 is smaller than 1st, 2nd, and 3rd qualifying places. This gives even more evidence that higher qualifying drivers (specifically 1st-3rd) are going to win the race. We did the calculation of the drivers 6-28 by filtering the positions not in the qualifying places. Then we calculated the count of the race wins for every driver in that category.

To better understand the bar graph above, we can also display the qualifying to race wins result as a frequency table:

```{r}
total_races_qualifying <- sum(combined_win_counts$race_wins) # add up the total number of races for percentage variable
qualifying_table <- combined_win_counts %>% # use dplyr forward pipe operator to create table
  group_by(position.x) %>% # group by qualifying position
  summarize(total_race_wins = sum(race_wins)) %>% # creating the race wins column
  mutate("Percent" = round(100*total_race_wins/total_races_qualifying, 2)) %>% #adding a percentage column
  rename("Qualifying Position" = position.x, "Race Wins" = total_race_wins) # renaming for better readability

# rendering the summary table using kable
kable(qualifying_table) %>%
  kable_styling(font_size = 24, full_width = TRUE) %>%
  add_header_above(c("Number of Race Wins By Qualifying Position" = 3))
```

From the table above to help us better quantify the bar graph from earlier, we can see even more of a strong correlation between a good qualifying position and having a better chance to win the race. In a practical sense, this information would be good for drivers and teams alike as it shows that qualifying is almost as important as the race itself and teams should be on their best performance on qualifying day. It is also somewhat remarkable that, since qualifying results become much more easily accessible, so for about half of all Formula 1 races through history, that first place qualifiers have won exactly half of all races, while all other positions 2-28 have won the same amount. 

Lastly, we wanted to take a deeper look at different teams and what teams had the most success in the most recent F1 season that we have the complete result data for, 2022. To do this, we will create a line graph with ten different lines (for each of the ten different teams that competed), and we will count their total number of points after each race of the season and accumulate them as we go. 

```{r}
# creating the data frame
races2022 <- simplified_races %>%
  filter(year == "2022")

results2022 <- results %>% # now we will make a table with just the fastest lap time from every year
  filter(raceId %in% races2022$raceId) %>% # making sure we only look at races in 2022
  left_join(races2022, by = "raceId") %>% # join with the 'races2022' table to see what year the race was
  left_join(constructors, by = "constructorId") %>% # join with 'constructors' so we see all team information
  arrange(raceId) # make sure the first race of the season is at the top

# from here, we can begin to add the points after each race for each constructor in a new data frame
cumulative_points <- results2022 %>%
  group_by(constructorRef) %>%
  mutate(Cumulative_Points = cumsum(points)) %>% # new variable that keeps tracks of each teams points after each race
  rename("Constructor" = constructorRef) %>% # to allow for a more presentable graph
  mutate(race_number = raceId - 1073) # this way, we can better track the race number within the season 

# creating vectors with proper team names and colors corresponding to team colors for the line graph
custom_team_names <- c( "Alfa Romeo", "AlphaTauri", "Alpine", "Aston Martin", "Ferrari", "Haas", "McLaren", "Mercedes", "Red Bull", "Williams")
custom_colors <- c("darkred",  "lightblue",  "pink", "seagreen4", "red", "black", "orange", "greenyellow", "blue4", "dodgerblue")  

# making the line graph with ggplot2
ggplot(cumulative_points, aes(x = race_number, y = Cumulative_Points, color = Constructor)) +
  geom_line() +
  labs(x = "Race", y = "Cumulative Points Earned",
       title = "Cumulative Points Earned by Team in 2022 Season") +
  theme_minimal() + # easier to look at
  theme(axis.text.x = element_text(size = 14, angle = 45, hjust = 1),  # rotating x-axis labels and adjusting font size
        axis.text.y = element_text(size = 14),  # adjusting font size of y-axis labels
        axis.title.x = element_text(size = 16),  # adjusting font size of x-axis label
        axis.title.y = element_text(size = 16),  # adjusting font size of y-axis label
        legend.key.size = unit(1.5, "lines"),  # increasing size and changing format of legend key
        legend.text = element_text(size = 14),  # adjusting font size of legend text
        legend.title = element_text(size = 16), # adjusting font size of legend title
        plot.title = element_text(size = 19)) +  # adjusting font size of legend title
  scale_color_manual(values = custom_colors, labels = custom_team_names) # injecting my custom colors and team names from earlier, crosschecked with the values in the 'cumulative_points' df to ensure values are correct 
```

From looking at the line graph that we produced, we can actually see that the team that had the strongest start by far, Ferrari, actually ended up in second by a large margin. As a matter of fact, by just looking at the top three teams in the final standings, we can see that each team followed a different pattern. Ferrari, like said before, had an extremely strong start, then leveled off, Mercedes had a somewhat slow start but stayed in it by having several really good races through the year, which are the giant spikes we can see, and lastly, Red Bull had a slow start but managed to gain points in every single race of the year, which ensured a large victory in the constructor's championship. From this, we can start to see that consistency is the key thing that teams should shoot for in order to try and win championships, rather than going out and trying to dominate every single race

## Final Conclusions
 
From our project, we have made three key conclusions in terms of succeeding in Formula 1

1) Lap times aren't everything:
  
  By the summary table comparing how many times the driver with the fastest lap has won the race, we can see that it has only happened in about 30% of races since 2004, so while it definitely is something teams and drivers should shoot for, it is definitely not the biggest factor in race success
  
2) Qualifying holds bigger stakes: 
  
  Compared to fastest lap times, qualifying holds a much bigger play in good race performance. Like seen in the bar graph discovering this subject earlier, qualifying first gives drivers the best shot at winning a race as 50% of all first place qualifiers have won that respective race. Teams can use this knowledge to better set up for race weekends by taking more time prepping the car for qualifying sessions and fans can use this information to better predict race results. 
  
3) Consistency is key:

  Finally, in the last visualization we made, we saw that, in terms of chasing a world championship, consistency is the biggest thing that teams can shoot for during the season. The most consistent teams in the line graph above were far and beyond more successful. Teams can use this information to better prepare for seasons so that they can try and set themselves up for a successful season and most of all, to try and model a season like Red Bull had in 2022.


