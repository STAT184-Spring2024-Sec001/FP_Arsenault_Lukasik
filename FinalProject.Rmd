---
title: "Final Project"
author: "Jacob Lukasik and Will Arsenault"
date: "2024-04-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## STAT184 Final Project: Analyzing Data From the FIA Formula 1 World Championship

For this project, we have found a very vast dataset regarding the FIA Formula 1 World Championship which contains Driver and Constructor information as well as, lap times, race results, and pit stop data from the inaugural season of the FIA Formula 1 World Championship, 1950, all the way up to the end of the 2023 season. With this dataset, we are striving to find and assess any connections that may be found that can show the relationships lap times and race success, along with qualifying performance and how well qualifying sets the driver up for success in the race. Lastly, we hope to look for any trends over the history of F1 that effect on track performance.

Link to the dataset:

<https://www.kaggle.com/datasets/rohanrao/formula-1-world-championship-1950-2020?select=results.csv>

## Step 1: Loading Data and Necessary Libraries

```{r message=FALSE}
library(ggplot2)
library(dplyr)
library(janitor)
library(kableExtra)
library(knitr)
```

```{r}
circuits <- read.csv('circuits.csv', header = TRUE)
const_results <- read.csv('constructor_results.csv', header = TRUE)
const_standings <- read.csv('constructor_standings.csv', header = TRUE)
constructors <- read.csv('constructors.csv', header = TRUE)
driver_standings <- read.csv('driver_standings.csv', header = TRUE)
drivers <- read.csv('drivers.csv', header = TRUE)
lap_times <- read.csv('lap_times.csv', header = TRUE)
pit_stops <- read.csv('pit_stops.csv', header = TRUE)
qualifying <- read.csv('qualifying.csv', header = TRUE)
races <- read.csv('races.csv', header = TRUE)
results <- read.csv('results.csv', header = TRUE)
seasons <- read.csv('seasons.csv', header = TRUE)
status <- read.csv('status.csv', header = TRUE)
```

The first insight into lap times we planned on finding was how lap times have gotten faster over the long history of Formula 1. To investigate this, we will first filter our data so that we have the fastest lap time from every season of F1 at Monza. We have keened in on this circuit in particular because it has been a mainstay in nearly every Formula 1 season, only not having a race held there in the 1980 season. Once we have a data frame containing just information regarding the fastest lap time at Monza every season, we can make a line graph and look for trends.

```{r}
simplified_races <- races %>% # simplifying the 'races' table for use later on
  select(raceId, year, circuitId, name)
only_monza <- races %>% # first we will only find races at monza from the 'races' data frame, then we will use those races to find the fastest lap times in 'results'
  filter(circuitId == 14) # inspecting the 'circuits' data frame tells us that Monza's circuitId is 14
monza_fastest_laps <- results %>% # now we will make a table with just the fastest lap time from every year
  filter(raceId %in% only_monza$raceId) %>% # making sure we only look at races at Monza
  filter(!is.na(fastestLapTime) & fastestLapTime != '\\N') %>% # make sure no N/A values are present
  group_by(raceId) %>% 
  summarize(fastestLapTime = min(fastestLapTime, na.rm = TRUE)) %>% # only contain the fastest lap time from each race
  left_join(simplified_races, by = "raceId") # join with the 'simplified_races' table to see what year the race was

ggplot(monza_fastest_laps, aes(x = year, y = fastestLapTime)) +
  geom_point(color = "blue", size = 3) +  # scatter plot with blue points
  labs(x = "Year", y = "Fastest Lap Time") + # labels for axes
  ggtitle("Fastest Lap Time by Year") + # main title
  theme_minimal() +  # minimalist theme
  theme(axis.text = element_text(size = 16), # axis text size
        axis.title = element_text(size = 16), # axis title size
        plot.title = element_text(size = 20, face = "bold")) # plot title size and style
```

Above, we can see that, since the year 2004 when the FIA started consistently keeping track of lap times, the cars have gotten overall slower than they were in the early 2000s. Now that we generally know the trend of lap times over the years, we can look more in depth at different statistics.

Now, we will see how often the driver who holds the title for the fastest lap time in a race, wins that race, along with how many times that driver has pulled off that feat.

Furthermore, we can also count the number of races since 2004 and then keep track of the percentage of times the fastest lap has converted into a race win.

```{r}
fastest_lap_wins <- results %>% # create a new data frame with just drivers who have won with the fastest lap
  filter(rank == 1) %>% # filter it so only fastest lap rows appear
  filter(positionOrder == 1) %>% # filter it so only winning drivers rows appear
  left_join(drivers, by = 'driverId') %>% # merge so that we can get the drivers name as well
  distinct(raceId, forename, surname, fastestLapTime) # pick out the information we need 

races_since_2004 <- races %>% # use this to calculate percentage later
  filter(year >= 2004)

summary_table <- fastest_lap_wins %>% # create a summary table
  tabyl(surname) %>% # group by surname
  adorn_totals() %>% # get the totals 
  arrange(desc(n)) %>% # sort from most to least
  rename("Surname" = surname, "Count" = n) %>% # rename columns for viewer
  select(Surname, Count) %>% # drop the percentage
  mutate("Percentage of All Races Since '04" = round(Count / nrow(races_since_2004), 3)) # create the new appropriate percentage 
  
# rendering the summary table using knitr
kable(summary_table) %>%
  kable_styling(font_size = 18, full_width = TRUE) %>%
  add_header_above(c("Most Wins While Simultaneously Winning Fastest Lap" = 3))
```

From this table, we can see that the driver with the fastest lap has won the same grand prix in around 31% of races since the year 2004. Along with that, we can see the different drivers who have done it the most time. From this, we learn the importance of recording fast lap times as, like said earlier, the driver with the highest chance of winning most of the time holds the title of the fastest lap.

From here, we can continue to look at other statistics and how they effect the outcome in the race. The next visualization will look at qualifying time and how often qualifying each first, second, third, fourth, and fifth generates a race win.

# Examining Qualifying Position

## Qualifying Positions Impact on Race Wins

From here, we can continue to look at other statistics and how they affect the outcome in the race. The next visualization will look at qualifying time and how often qualifying each first, second, third, fourth, and fifth generates a race win. We will make a bar graph to display the amount of times the qualifying positions of 1st - 5th actually won the race. We also can filter the drivers in qualifying positions 6-28 and add there wins to see how there total count if wins compares to the drivers in the qualifying positions 1st-5th.

```{r}
# Filter qualifying positions 1st to 5th
qualifying_positions <- qualifying %>%
  filter(position <= 5) # Filter the qualifying positions 1st-5th

# Join with results on raceId and driverId
qualifying_results <- qualifying_positions %>%
  inner_join(results, by = c("raceId", "driverId"))

# Filter where positionOrder is 1 (indicating the driver won the race)
qualifying_winners <- qualifying_results %>%
  filter(positionOrder == 1)

# Calculate the number of race wins for each qualifying position
win_counts <- qualifying_winners %>%
  group_by(position.x) %>%
  summarize(race_wins = n())

# Create a new category for all other qualifying positions
other_positions <- qualifying %>%
  filter(!(position %in% 1:5)) %>%
  mutate(position.x = "Other (6-28)")

# Join with results on raceId and driverId
other_results <- other_positions %>%
  inner_join(results, by = c("raceId", "driverId"))

# Filter where positionOrder is 1 (indicating the driver won the race)
other_winners <- other_results %>%
  filter(positionOrder == 1)

# Calculate the number of race wins for "Other" qualifying positions
other_win_counts <- other_winners %>%
  group_by(position.x.x) %>%
  summarize(race_wins = n()) %>%
  rename("position.x" = position.x.x)

# Combine win_counts and other_win_counts
win_counts$position.x <- as.character(win_counts$position.x)
combined_win_counts <- bind_rows(win_counts, other_win_counts)

# Create a vector of colors
bar_colors <- c("skyblue", "lightgreen", "orange", "pink", "purple", "gray")  # Add a color for "Other"

# Make the bar graph with ggplot2
ggplot(combined_win_counts, aes(x = factor(position.x), y = race_wins, fill = factor(position.x))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = bar_colors) +  # Apply custom colors
  labs(x = "Qualifying Position", y = "Number of Race Wins", 
       title = "Race Wins by Qualifying Position") +
  theme_minimal() +
  theme(axis.text = element_text(size = 14), # Change font sizes
        axis.title = element_text(size = 18), 
        plot.title = element_text(size = 20, face = "bold"),
        legend.position = "none") +  # Remove legend
  guides(fill = 'none')  # Remove fill guide
```

As we can see from the above bar graph, a majority of the time the racer who is in the 1st qualifying position will actually win the race. The number of wins rapidly decreases as each qualifying postion increases. There could be a variety of factors that contributed to the 1st qualifying positon winning the most races. The main factor definitely would be the driver skill because the driver had to do something in order to get that high of a qualifying position for that specific race. If you did not know the qualifying position is similar to a ranking system in sports. The highest ranked driver for that specific race will get the highest qualifying position. This allows that driver to get a bit of a head start on top of all the other drivers that are participating in that race.

We also did calculations for all other drivers in the race (qualifying places 6-28). As you can see in the above graph the category of 6-28 is smaller than 1st, 2nd, and 3rd qualifying places. This gives even more evidence that higher qualifying drivers (specifically 1st-3rd) are going to win the race. We did the calculation of the drivers 6-28 by filtering the positions not in the qualifying places. Then we calculated the count of the race wins for every driver in that category.
